export default {
  async fetch(request, env) {
      const url = new URL(request.url);
      if (url.pathname === '/') {
          return new Response(`<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n\n        <div class=\"form-group\">\n            <label for=\"authorization\"></label>\n           <input type=\"text\" id=\"authorization\" style=\"display: none;\">\n        </div>\n        \n        <button id=\"submit-btn\"></button>\n        <script>\n             document.getElementById(\"submit-btn\").style.display = \"none\";\n        </script>\n        \n        <div class=\"loader\" id=\"loader\">\n            <div class=\"loader-spinner\"></div>\n            <p style=\"margin-top: 10px;\">正在获取，请稍候...</p>\n        </div>\n        \n        <div class=\"result\" id=\"result\">\n            <div class=\"result-title\"></div>\n            <div id=\"latest-indicator\" class=\"latest-indicator\">这是最新的一条结果</div>\n            <pre id=\"result-content\"></pre>\n        </div>\n        \n        <div class=\"url-example\">\n    </div>\n\n    <script>\n        document.addEventListener(\'DOMContentLoaded\', function() {\n            const submitBtn = document.getElementById(\'submit-btn\');\n            const authorizationInput = document.getElementById(\'authorization\');\n            const resultDiv = document.getElementById(\'result\');\n            const resultContent = document.getElementById(\'result-content\');\n            const loader = document.getElementById(\'loader\');\n            const latestIndicator = document.getElementById(\'latest-indicator\');\n            \n            // 从URL参数获取token\n            const urlParams = new URLSearchParams(window.location.search);\n            const tokenFromUrl = urlParams.get(\'token\');\n            \n            // 如果URL中有token，则填充到输入框并自动查询\n            if (tokenFromUrl) {\n                authorizationInput.value = tokenFromUrl;\n                fetchEmailList(tokenFromUrl);\n            }\n            \n            submitBtn.addEventListener(\'click\', function() {\n                const authToken = authorizationInput.value.trim();\n                \n                if (!authToken) {\n                    alert(\'请输入身份令牌\');\n                    return;\n                }\n                \n                // 更新URL，添加token参数\n                const newUrl = new URL(window.location);\n                newUrl.searchParams.set(\'token\', authToken);\n                window.history.replaceState({}, \'\', newUrl);\n                \n                fetchEmailList(authToken);\n            });\n            \n            function fetchEmailList(authToken) {\n                // 显示加载中，隐藏结果\n                loader.style.display = \'block\';\n                resultDiv.style.display = \'none\';\n                submitBtn.disabled = true;\n                \n                // 准备请求数据\n                const requestData = {\n                    page: 1,\n                    limit: 20\n                };\n                \n                // 发送POST请求\n                fetch(\'/api/public/emailList\', {\n                    method: \'POST\',\n                    headers: {\n                        \'Authorization\': authToken,\n                        \'Content-Type\': \'application/json\'\n                    },\n                    body: JSON.stringify(requestData)\n                })\n                .then(response => {\n                    if (!response.ok) {\n                        throw new Error(\`HTTP错误! 状态: \${response.status}\`);\n                    }\n                    return response.json();\n                })\n                .then(data => {\n                    // 显示成功结果\n                    if (data.data && data.data.length > 0) {\n                        // 获取最新的一条数据\n                        const latestEmail = data.data[0];\n                        resultContent.textContent = JSON.stringify(latestEmail, null, 2);\n                        latestIndicator.style.display = \'block\';\n                    } else {\n                        resultContent.textContent = JSON.stringify(data, null, 2);\n                        latestIndicator.style.display = \'none\';\n                    }\n                    \n                    resultDiv.className = \'result success\';\n                    resultDiv.style.display = \'block\';\n                })\n                .catch(error => {\n                    // 显示错误信息\n                    resultContent.textContent = \`错误: \${error.message}\`;\n                    resultDiv.className = \'result error\';\n                    resultDiv.style.display = \'block\';\n                    latestIndicator.style.display = \'none\';\n                })\n                .finally(() => {\n                    // 隐藏加载指示器\n                    loader.style.display = \'none\';\n                    submitBtn.disabled = false;\n                });\n            }\n        });\n    </script>\n<html>\n	<head>\n		<meta charset=\"utf-8\" />\n		<meta http-equiv=\"refresh\" content=\"20\" >\n	</head>\n	<body>\n</html>\n`, {
              headers: { 'Content-Type': 'text/html; charset=utf-8' }
          });
      }
      return new Response('Not Found', { status: 404 });
  }
}